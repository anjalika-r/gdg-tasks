<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat API Tester</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .config {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .config input {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .auth-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }

        .auth-status.logged-in {
            background: #d4edda;
            color: #155724;
        }

        .auth-status.logged-out {
            background: #f8d7da;
            color: #721c24;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 5px;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .response {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .response.error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .response.success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .chat-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chat-window {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f9f9f9;
        }

        .chat-window h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .message {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .message.sent {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .message.received {
            background: #e9ecef;
            color: #333;
            margin-right: 20%;
        }

        .message-info {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 3px;
        }

        .websocket-status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .websocket-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .websocket-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .websocket-status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Chat API Tester</h1>

        <div class="config">
            <label for="apiUrl">API Base URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:8000" placeholder="http://localhost:8000">
        </div>

        <div id="authStatus" class="auth-status logged-out">Not logged in</div>

        <!-- Authentication Section -->
        <div class="section">
            <h2>üîê Authentication</h2>
            <div class="two-columns">
                <div>
                    <h3>Register</h3>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="regUsername" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="regPassword" placeholder="password">
                    </div>
                    <div class="form-group">
                        <label>Email (optional):</label>
                        <input type="email" id="regEmail" placeholder="email@example.com">
                    </div>
                    <button onclick="register()">Register</button>
                </div>
                <div>
                    <h3>Login</h3>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" id="loginUsername" placeholder="username">
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="loginPassword" placeholder="password">
                    </div>
                    <button onclick="login()">Login</button>
                    <button onclick="logout()">Logout</button>
                </div>
            </div>
            <div id="authResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Profile Section -->
        <div class="section">
            <h2>üë§ Profile Management</h2>
            <button onclick="getProfile()">Get My Profile</button>
            <button onclick="updateProfile()">Update Profile</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>Display Name:</label>
                <input type="text" id="displayName" placeholder="Display Name">
            </div>
            <div class="form-group">
                <label>Bio:</label>
                <textarea id="bio" placeholder="Bio"></textarea>
            </div>
            <div id="profileResponse" class="response" style="display:none;"></div>
        </div>

        <!-- WebSocket Section -->
        <div class="section">
            <h2>üí¨ WebSocket Chat</h2>
            <div id="wsStatus" class="websocket-status disconnected">Disconnected</div>
            <button onclick="connectWebSocket()" id="connectBtn">Connect</button>
            <button onclick="disconnectWebSocket()" id="disconnectBtn" disabled>Disconnect</button>
            <div id="wsResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Message History Section -->
        <div class="section">
            <h2>üìú Message History</h2>
            <div class="form-group">
                <label>User ID to get chat history with:</label>
                <input type="text" id="chatUserId" placeholder="User ID">
            </div>
            <button onclick="getMessageHistory()">Get Message History</button>
            <div id="historyResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Real-time Chat Section -->
        <div class="section">
            <h2>üí¨ Real-time Chat</h2>
            <div class="form-group">
                <label>Receiver User ID:</label>
                <input type="text" id="receiverId" placeholder="User ID of receiver">
            </div>
            <div class="form-group">
                <label>Message:</label>
                <textarea id="messageContent" placeholder="Type your message..."></textarea>
            </div>
            <button onclick="sendMessage()" id="sendBtn" disabled>Send Message</button>
            
            <div class="chat-container">
                <div class="chat-window">
                    <h3>Sent Messages</h3>
                    <div id="sentMessages" class="chat-messages"></div>
                </div>
                <div class="chat-window">
                    <h3>Received Messages</h3>
                    <div id="receivedMessages" class="chat-messages"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let userId = null;
        let socket = null;
        const apiUrl = () => document.getElementById('apiUrl').value;

        // Update auth status
        function updateAuthStatus() {
            const statusEl = document.getElementById('authStatus');
            if (token) {
                statusEl.className = 'auth-status logged-in';
                statusEl.textContent = `Logged in as user: ${userId || 'Unknown'}`;
            } else {
                statusEl.className = 'auth-status logged-out';
                statusEl.textContent = 'Not logged in';
            }
        }

        // Show response helper
        function showResponse(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = 'response' + (isError ? ' error' : ' success');
            el.textContent = JSON.stringify(data, null, 2);
        }

        // Register
        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const email = document.getElementById('regEmail').value;

            if (!username || !password) {
                showResponse('authResponse', {msg: 'Username and password are required'}, true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, email})
                });
                const data = await response.json();
                showResponse('authResponse', data, !response.ok);
            } catch (error) {
                showResponse('authResponse', {msg: error.message}, true);
            }
        }

        // Login
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showResponse('authResponse', {msg: 'Username and password are required'}, true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    token = data.access_token;
                    // Decode token to get user ID (simple base64 decode of JWT payload)
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    userId = payload.sub;
                    updateAuthStatus();
                    showResponse('authResponse', {msg: 'Login successful', token: token.substring(0, 20) + '...'}, false);
                } else {
                    showResponse('authResponse', data, true);
                }
            } catch (error) {
                showResponse('authResponse', {msg: error.message}, true);
            }
        }

        // Logout
        function logout() {
            token = null;
            userId = null;
            updateAuthStatus();
            disconnectWebSocket();
            showResponse('authResponse', {msg: 'Logged out'}, false);
        }

        // Get Profile
        async function getProfile() {
            if (!token) {
                showResponse('profileResponse', {msg: 'Please login first'}, true);
                return;
            }

            try {
                // First check if server is reachable
                const healthCheck = await fetch(`${apiUrl()}/health`).catch(() => null);
                if (!healthCheck) {
                    showResponse('profileResponse', {
                        msg: 'Server not reachable. Make sure the server is running on ' + apiUrl(),
                        error: 'Connection failed'
                    }, true);
                    return;
                }

                const response = await fetch(`${apiUrl()}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Handle non-JSON responses
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = {msg: text, status: response.status};
                }
                
                if (response.ok) {
                    document.getElementById('displayName').value = data.profile?.display_name || '';
                    document.getElementById('bio').value = data.profile?.bio || '';
                }
                
                showResponse('profileResponse', {status: response.status, ...data}, !response.ok);
            } catch (error) {
                const errorDetails = {
                    msg: 'Failed to fetch: ' + error.message,
                    error: error.toString(),
                    errorType: error.name,
                    hint: 'Check if server is running and API URL is correct',
                    apiUrl: apiUrl(),
                    hasToken: !!token,
                    tokenPreview: token ? token.substring(0, 20) + '...' : 'No token'
                };
                console.error('Profile fetch error:', errorDetails, error);
                showResponse('profileResponse', errorDetails, true);
            }
        }

        // Update Profile
        async function updateProfile() {
            if (!token) {
                showResponse('profileResponse', {msg: 'Please login first'}, true);
                return;
            }

            const displayName = document.getElementById('displayName').value;
            const bio = document.getElementById('bio').value;

            try {
                const response = await fetch(`${apiUrl()}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        profile: {
                            display_name: displayName,
                            bio: bio
                        }
                    })
                });
                const data = await response.json();
                showResponse('profileResponse', data, !response.ok);
            } catch (error) {
                showResponse('profileResponse', {msg: error.message}, true);
            }
        }

        // Connect WebSocket
        function connectWebSocket() {
            if (!token) {
                showResponse('wsResponse', {msg: 'Please login first'}, true);
                return;
            }

            if (socket && socket.connected) {
                showResponse('wsResponse', {msg: 'Already connected'}, false);
                return;
            }

            const statusEl = document.getElementById('wsStatus');
            statusEl.className = 'websocket-status connecting';
            statusEl.textContent = 'Connecting...';

            socket = io(apiUrl(), {
                auth: { token: token },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                statusEl.className = 'websocket-status connected';
                statusEl.textContent = 'Connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                showResponse('wsResponse', {msg: 'Connected successfully'}, false);
            });

            socket.on('disconnect', () => {
                statusEl.className = 'websocket-status disconnected';
                statusEl.textContent = 'Disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            });

            socket.on('connected', (data) => {
                showResponse('wsResponse', {event: 'connected', data}, false);
            });

            socket.on('error', (data) => {
                showResponse('wsResponse', {event: 'error', data}, true);
            });

            socket.on('message_received', (data) => {
                showResponse('wsResponse', {event: 'message_received', data}, false);
                addMessage(data, 'received');
            });

            socket.on('message_sent', (data) => {
                showResponse('wsResponse', {event: 'message_sent', data}, false);
                addMessage(data, 'sent');
            });
        }

        // Disconnect WebSocket
        function disconnectWebSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        // Send Message
        function sendMessage() {
            if (!socket || !socket.connected) {
                showResponse('wsResponse', {msg: 'WebSocket not connected'}, true);
                return;
            }

            const receiverId = document.getElementById('receiverId').value;
            const content = document.getElementById('messageContent').value;

            if (!receiverId || !content) {
                showResponse('wsResponse', {msg: 'Receiver ID and message content are required'}, true);
                return;
            }

            socket.emit('send_message', {
                receiver_id: receiverId,
                content: content
            });

            document.getElementById('messageContent').value = '';
        }

        // Add message to chat window
        function addMessage(data, type) {
            const container = document.getElementById(type === 'sent' ? 'sentMessages' : 'receivedMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const time = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'now';
            messageEl.innerHTML = `
                <div>${data.content}</div>
                <div class="message-info">To: ${data.receiver_id} | From: ${data.sender_id} | ${time}</div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        // Get Message History
        async function getMessageHistory() {
            if (!token) {
                showResponse('historyResponse', {msg: 'Please login first'}, true);
                return;
            }

            const userId = document.getElementById('chatUserId').value;
            if (!userId) {
                showResponse('historyResponse', {msg: 'User ID is required'}, true);
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/messages/${userId}`, {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                const data = await response.json();
                showResponse('historyResponse', data, !response.ok);
            } catch (error) {
                showResponse('historyResponse', {msg: error.message}, true);
            }
        }

        // Initialize
        updateAuthStatus();
    </script>
</body>
</html>
